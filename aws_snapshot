pipeline {
    agent any
 
    environment {
        AWS_REGION = 'eu-north-1b'               // Set your AWS region
        DAYS_OLD = 0                           // Number of days after which a snapshot is considered old
    }
 
    stages {
        stage('List Old Snapshots') {
            steps {
                withAWS(region: AWS_REGION, credentials: 'aws-credentials') {  // 'aws-credentials' is the Jenkins credential ID
                    echo "Listing snapshots created before today (midnight)..."
                        current_date=\$(date +%Y-%m-%d)
                        midnight_date=\$(date -d "\$current_date" +%Y-%m-%dT00:00:00Z)
                        aws ec2 describe-snapshots \
                        --region ${AWS_REGION} \
                        --query "Snapshots[?StartTime<'\$midnight_date'].[SnapshotId, StartTime]" \
                        --output table
                }
            }
        }
 
        stage('Delete Old Snapshots') {
            steps {
                withAWS(region: AWS_REGION, credentials: 'aws-credentials') {
                    echo "Deleting old snapshots created before today (midnight)..."
                        current_date=\$(date +%Y-%m-%d)
                        midnight_date=\$(date -d "\$current_date" +%Y-%m-%dT00:00:00Z)
                        for snapshot in \$(aws ec2 describe-snapshots \
                            --region ${AWS_REGION} \
                            --query "Snapshots[?StartTime<'\$midnight_date'].SnapshotId" \
                            --output text); do
                            echo "Deleting snapshot \$snapshot"
                            aws ec2 delete-snapshot --region ${AWS_REGION} --snapshot-id \$snapshot
                        done
                }
            }
        }
    }
 
    post {
        success {
            echo "Pipeline completed successfully. Old snapshots deleted."
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}
